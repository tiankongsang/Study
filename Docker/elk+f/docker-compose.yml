version: "3"
services:
  nginx:
    image: nginx
    container_name: nginx
    restart: always
    ports:
      - 80:80
    volumes:
      - ./nginx/log:/var/log/nginx
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost"]
      interval: 1m30s
      timeout: 10s
      retries: 3
      start_period: 40s
  logstash:
    container_name: logstash
    ports:
      - 5044:5044
    build:
      context: ./logstash
      dockerfile: Dockerfile
    depends_on:
      - nginx
    volumes:
      - ./logstash/conf:/opt/logstash/conf
    restart: always
  elasticsearch:
    container_name: elasticsearch
    ports:
      - 9200:9200
      - 9300:9300
    build:
      context: ./elasticsearch
      dockerfile: Dockerfile
    volumes:
      - ./elasticsearch/log:/var/log/elasticsearch
    restart: always
    depends_on:
      - logstash
  kibana:
    container_name: kibana
    build:
      context: ./kibana
      dockerfile: Dockerfile
    ports:
      - 5601:5601
    restart: always
    depends_on:
      - elasticsearch
  filebeat:
    build:
      context: ./filebeat
      dockerfile: Dockerfile
    container_name: filebeat
    depends_on:
      - kibana
    volumes:
      - ./nginx/log:/var/log/nginx
    restart: always
networks:
  default:
    external:
      name: elk
